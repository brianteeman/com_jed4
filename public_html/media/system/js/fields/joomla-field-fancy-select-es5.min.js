"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var n,o=_getPrototypeOf(e);if(t){var c=_getPrototypeOf(this).constructor;n=Reflect.construct(o,arguments,c)}else n=o.apply(this,arguments);return _possibleConstructorReturn(this,n)}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _wrapNativeSuper(e){var t="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(n,e)})(e)}function _construct(e,t,n){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(e,t,n){var o=[null];o.push.apply(o,t);var c=new(Function.bind.apply(e,o));return n&&_setPrototypeOf(c,n.prototype),c}).apply(null,arguments)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}window.customElements.define("joomla-field-fancy-select",function(e){_inherits(n,_wrapNativeSuper(HTMLElement));var t=_createSuper(n);function n(){var e;if(_classCallCheck(this,n),(e=t.call(this)).keyCode={ENTER:13},!Joomla)throw new Error("Joomla API is not properly initiated");if(!window.Choices)throw new Error("JoomlaFieldFancySelect requires Choices.js to work");return e.choicesCache={},e.activeXHR=null,e.choicesInstance=null,e.isDisconnected=!1,e}return _createClass(n,[{key:"allowCustom",get:function(){return this.hasAttribute("allow-custom")}},{key:"remoteSearch",get:function(){return this.hasAttribute("remote-search")}},{key:"url",get:function(){return this.getAttribute("url")}},{key:"termKey",get:function(){return this.getAttribute("term-key")||"term"}},{key:"minTermLength",get:function(){return parseInt(this.getAttribute("min-term-length"),10)||1}},{key:"newItemPrefix",get:function(){return this.getAttribute("new-item-prefix")||""}},{key:"placeholder",get:function(){return this.getAttribute("placeholder")}},{key:"searchPlaceholder",get:function(){return this.getAttribute("search-placeholder")}},{key:"value",get:function(){return this.choicesInstance.getValue(!0)},set:function(e){this.choicesInstance.setChoiceByValue(e)}},{key:"connectedCallback",value:function(){var e=this;if(window.Choices||"complete"===document.readyState)this.doConnect();else{window.addEventListener("load",(function t(){e.doConnect(),window.removeEventListener("load",t)}))}}},{key:"doConnect",value:function(){var e=this;if(this.select=this.querySelector("select"),!this.select)throw new Error("JoomlaFieldFancySelect requires <select> element to work");if(this.choicesInstance)this.isDisconnected&&(this.choicesInstance.init(),this.isDisconnected=!1);else{if(this.isDisconnected=!1,this.select.multiple&&this.placeholder){var t=document.createElement("option");t.setAttribute("placeholder",""),t.textContent=this.placeholder,this.select.appendChild(t)}if(this.choicesInstance=new Choices(this.select,{placeholderValue:this.placeholder,searchPlaceholderValue:this.searchPlaceholder,removeItemButton:!0,searchFloor:this.minTermLength,searchResultLimit:10,shouldSort:!1,fuseOptions:{threshold:.3},noResultsText:Joomla.Text._("JGLOBAL_SELECT_NO_RESULTS_MATCH","No results found"),noChoicesText:Joomla.Text._("JGLOBAL_SELECT_NO_RESULTS_MATCH","No results found"),itemSelectText:Joomla.Text._("JGLOBAL_SELECT_PRESS_TO_SELECT","Press to select"),classNames:{button:"choices__button_joomla"}}),this.allowCustom){var n=this.choicesInstance._highlightChoice;this.choicesInstance._highlightChoice=function(t){t&&n.call(e.choicesInstance,t)},this.addEventListener("mouseleave",(function(){e.choicesInstance.dropdown.isActive&&(Array.from(e.choicesInstance.dropdown.element.querySelectorAll(".".concat(e.choicesInstance.config.classNames.highlightedState))).forEach((function(t){t.classList.remove(e.choicesInstance.config.classNames.highlightedState),t.setAttribute("aria-selected","false")})),e.choicesInstance._highlightPosition=0)})),this.addEventListener("keydown",(function(t){if(t.keyCode===e.keyCode.ENTER&&t.target===e.choicesInstance.input.element&&(t.preventDefault(),!e.choicesInstance._highlightPosition&&t.target.value&&!e.choicesInstance.dropdown.element.querySelector(".".concat(e.choicesInstance.config.classNames.highlightedState)))){var n=t.target.value.toLowerCase(),o=!1;if(e.choicesInstance.config.choices.some((function(e){return(e.value.toLowerCase()===n||e.label.toLowerCase()===n)&&(o=e.value,!0)})),!1===o&&Object.keys(e.choicesCache).some((function(t){return(t.toLowerCase()===n||e.choicesCache[t].toLowerCase()===n)&&(o=t,!0)})),!1!==o)return e.choicesInstance.setChoiceByValue(o),t.target.value=null,void e.choicesInstance.hideDropdown();e.choicesInstance.setChoices([{value:e.newItemPrefix+t.target.value,label:t.target.value,selected:!0,customProperties:{value:t.target.value}}],"value","label",!1),e.choicesCache[t.target.value]=t.target.value,t.target.value=null,e.choicesInstance.hideDropdown()}}))}if(this.remoteSearch&&this.url){this.choicesInstance.config.choices.forEach((function(t){e.choicesCache[t.value]=t.label}));var o=null;this.select.addEventListener("search",(function(){clearTimeout(o),o=setTimeout(e.requestLookup.bind(e),300)}))}}}},{key:"disconnectedCallback",value:function(){this.choicesInstance&&(this.choicesInstance.destroy(),this.isDisconnected=!0),this.activeXHR&&(this.activeXHR.abort(),this.activeXHR=null)}},{key:"requestLookup",value:function(){var e=this,t=this.url;t+=-1===t.indexOf("?")?"?":"&",t+="".concat(encodeURIComponent(this.termKey),"=").concat(encodeURIComponent(this.choicesInstance.input.value)),this.activeXHR&&this.activeXHR.abort(),this.activeXHR=Joomla.request({url:t,onSuccess:function(t){e.activeXHR=null;var n=t?JSON.parse(t):[];if(n.length){for(var o,c=n.length-1;c>=0;c--)(o=n[c]).value=""+o.value,e.choicesCache[o.value]?n.splice(c,1):e.choicesCache[o.value]=o.text;n.length&&e.choicesInstance.setChoices(n,"value","text",!1)}},onError:function(){e.activeXHR=null}})}},{key:"disableAllOptions",value:function(){var e=this.choicesInstance._store.choices;e.forEach((function(t,n){e[n].disabled=!0,e[n].selected=!1})),this.choicesInstance.clearStore(),this.choicesInstance.setChoices(e,"value","label",!0)}},{key:"enableAllOptions",value:function(){var e=this.choicesInstance._store.choices,t=this.choicesInstance.getValue(!0);e.forEach((function(t,n){e[n].disabled=!1})),this.choicesInstance.clearStore(),this.choicesInstance.setChoices(e,"value","label",!0),this.value=t}},{key:"disableByValue",value:function(e){var t=this.choicesInstance._store.choices,n=this.choicesInstance.getValue(!0);t.forEach((function(n,o){n.value===e&&(t[o].disabled=!0,t[o].selected=!1)}));var o=n.indexOf(e);o>-1&&n.slice(o,1),this.choicesInstance.clearStore(),this.choicesInstance.setChoices(t,"value","label",!0),this.value=n}},{key:"enableByValue",value:function(e){var t=this.choicesInstance._store.choices,n=this.choicesInstance.getValue(!0);t.forEach((function(n,o){n.value===e&&(t[o].disabled=!1)})),this.choicesInstance.clearStore(),this.choicesInstance.setChoices(t,"value","label",!0),this.value=n}}]),n}());