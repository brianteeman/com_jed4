"use strict";(a=>{'use strict';function b(a){return a.ctrlKey||a.metaKey||a.shiftKey}const c={SPACE:32,ESC:27,ENTER:13};class d extends HTMLElement{get buttonAdd(){return this.getAttribute("button-add")}get buttonRemove(){return this.getAttribute("button-remove")}get buttonMove(){return this.getAttribute("button-move")}get rowsContainer(){return this.getAttribute("rows-container")}get repeatableElement(){return this.getAttribute("repeatable-element")}get minimum(){return this.getAttribute("minimum")}get maximum(){return this.getAttribute("maximum")}get name(){return this.getAttribute("name")}set name(a){return this.template=this.template.replace(new RegExp(` name="${this.name.replace(/[[\]]/g,"\\$&")}`,"g"),` name="${a}`),this.setAttribute("name",a)}constructor(){super();const a=this;if(this.containerWithRows=this,this.rowsContainer){const a=this.querySelectorAll(this.rowsContainer);Array.from(a).forEach(a=>{a.closest("joomla-field-subform")===this&&(this.containerWithRows=a)})}this.lastRowIndex=this.getRows().length-1,this.template="",this.prepareTemplate(),(this.buttonAdd||this.buttonRemove)&&(this.addEventListener("click",b=>{let c=null,d=null;if(a.buttonAdd&&(c=b.target.matches(a.buttonAdd)?b.target:b.target.closest(a.buttonAdd)),a.buttonRemove&&(d=b.target.matches(a.buttonRemove)?b.target:b.target.closest(a.buttonRemove)),c&&c.closest("joomla-field-subform")===a){let d=c.closest("joomla-field-subform");d=d.closest(a.repeatableElement)===a?d:null,a.addRow(d),b.preventDefault()}else if(d&&d.closest("joomla-field-subform")===a){const c=d.closest(a.repeatableElement);a.removeRow(c),b.preventDefault()}}),this.addEventListener("keydown",b=>{if(b.keyCode!==c.SPACE)return;const d=a.buttonAdd&&b.target.matches(a.buttonAdd),e=a.buttonRemove&&b.target.matches(a.buttonRemove);if((d||e)&&b.target.closest("joomla-field-subform")===a){let c=b.target.closest("joomla-field-subform");c=c.closest(a.repeatableElement)===a?c:null,e&&c?a.removeRow(c):d&&a.addRow(c),b.preventDefault()}})),this.buttonMove&&this.setUpDragSort()}getRows(){const a=Array.from(this.containerWithRows.children),b=[];return a.forEach(a=>{a.matches(this.repeatableElement)&&b.push(a)}),b}prepareTemplate(){const a=[].slice.call(this.children).filter(a=>a.classList.contains("subform-repeatable-template-section"));if(a[0]&&(this.template=a[0].innerHTML),!this.template)throw new Error("The row template are required to subform element to work")}addRow(a){const b=this.getRows().length;if(b>=this.maximum)return null;let c;c="TBODY"===this.containerWithRows.nodeName||"TABLE"===this.containerWithRows.nodeName?document.createElement("tbody"):document.createElement("div"),c.innerHTML=this.template;const d=c.children[0];return a?a.parentNode.insertBefore(d,a.nextSibling):this.containerWithRows.append(d),this.buttonMove&&(d.setAttribute("draggable","false"),d.setAttribute("aria-grabbed","false"),d.setAttribute("tabindex","0")),d.setAttribute("data-new","1"),this.fixUniqueAttributes(d,b),this.dispatchEvent(new CustomEvent("subform-row-add",{detail:{row:d},bubbles:!0})),window.Joomla&&Joomla.Event.dispatch(d,"joomla:updated"),d}removeRow(a){const b=this.getRows().length;b<=this.minimum||(this.dispatchEvent(new CustomEvent("subform-row-remove",{detail:{row:a},bubbles:!0})),window.Joomla&&Joomla.Event.dispatch(a,"joomla:removed"),a.parentNode.removeChild(a))}fixUniqueAttributes(a,b){const c=a.getAttribute("data-group"),d=a.getAttribute("data-base-name"),e=Math.max(this.lastRowIndex,b||0),f=d+e;this.lastRowIndex=e+1,a.setAttribute("data-group",f);let g=a.querySelectorAll("[name]");const h={};g=[].slice.call(g).filter(a=>a.closest("joomla-field-subform")===this),g.forEach(b=>{const d=b,e=d.getAttribute("name"),g=e.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),i=e.replace(`[${c}][`,`[${f}][`);let j=g.replace(c,f).replace(/\W/g,"_"),k=0,l=g;if("checkbox"===d.type&&e.match(/\[\]$/)){if(k=h[g]?h[g].length:0,!k){const b=d.closest("fieldset.checkboxes"),c=a.querySelector(`label[for="${g}"]`);b&&b.setAttribute("id",j),c&&(c.setAttribute("for",j),c.setAttribute("id",`${j}-lbl`))}l+=k,j+=k}else if("radio"===d.type){if(k=h[g]?h[g].length:0,!k){const b=d.closest("fieldset.radio"),c=a.querySelector(`label[for="${g}"]`);b&&b.setAttribute("id",j),c&&(c.setAttribute("for",j),c.setAttribute("id",`${j}-lbl`))}l+=k,j+=k}h[g]?h[g].push(!0):h[g]=[!0],d.name=i,d.id&&(d.id=j);const m=a.querySelector(`label[for="${l}"]`);m&&(m.setAttribute("for",j),m.setAttribute("id",`${j}-lbl`))})}setUpDragSort(){function a(a){return!a.form&&a.matches(e.buttonMove)?a:a.closest(e.buttonMove)}function d(a,b){let c=!1;if(a.parentNode===b.parentNode)for(let d=a;d;d=d.previousSibling)if(d===b){c=!0;break}c?b.parentNode.insertBefore(a,b):b.parentNode.insertBefore(a,b.nextSibling)}const e=this;let f=null,g=!1;const h=Array.from(this.getRows());h.forEach(a=>{a.setAttribute("draggable","false"),a.setAttribute("aria-grabbed","false"),a.setAttribute("tabindex","0")}),this.addEventListener("touchstart",b=>{g=!0;const c=a(b.target),h=c?c.closest(e.repeatableElement):null;h&&h.closest("joomla-field-subform")===e&&(f?(h!==f&&d(f,h),f.setAttribute("draggable","false"),f.setAttribute("aria-grabbed","false"),f=null):(h.setAttribute("draggable","true"),h.setAttribute("aria-grabbed","true"),f=h),b.preventDefault())}),this.addEventListener("mousedown",({target:b})=>{if(g)return;const c=a(b),d=c?c.closest(e.repeatableElement):null;d&&d.closest("joomla-field-subform")===e&&(d.setAttribute("draggable","true"),d.setAttribute("aria-grabbed","true"),f=d)}),this.addEventListener("mouseup",()=>{f&&!g&&(f.setAttribute("draggable","false"),f.setAttribute("aria-grabbed","false"),f=null)}),this.addEventListener("keydown",a=>{if((a.keyCode===c.ESC||a.keyCode===c.SPACE||a.keyCode===c.ENTER)&&!a.target.form&&a.target.matches(e.repeatableElement)){const g=a.target;if(g&&g.closest("joomla-field-subform")===e&&(a.keyCode===c.SPACE&&b(a)&&("true"===g.getAttribute("aria-grabbed")?(g.setAttribute("draggable","false"),g.setAttribute("aria-grabbed","false"),f=null):(f&&(f.setAttribute("draggable","false"),f.setAttribute("aria-grabbed","false"),f=null),g.setAttribute("draggable","true"),g.setAttribute("aria-grabbed","true"),f=g),a.preventDefault()),a.keyCode===c.ESC&&f&&(f.setAttribute("draggable","false"),f.setAttribute("aria-grabbed","false"),f=null),a.keyCode===c.ENTER&&f)){if(f.setAttribute("draggable","false"),f.setAttribute("aria-grabbed","false"),g===f)return void(f=null);d(f,g),a.preventDefault(),f=null}}}),this.addEventListener("dragstart",({dataTransfer:a})=>{f&&(a.effectAllowed="move",a.setData("text",""))}),this.addEventListener("dragover",a=>{f&&a.preventDefault()}),this.addEventListener("dragenter",({target:a})=>{if(f&&(!e.rowsContainer||a.closest(e.rowsContainer)===e.containerWithRows)){const b=a.matches(e.repeatableElement)?a:a.closest(e.repeatableElement);b&&d(f,b)}}),this.addEventListener("dragend",()=>{f&&(f.setAttribute("draggable","false"),f.setAttribute("aria-grabbed","false"),f=null)})}}a.define("joomla-field-subform",d)})(customElements);