"use strict";(t=>{const e=32,r=27,a=13;class s extends HTMLElement{get buttonAdd(){return this.getAttribute("button-add")}get buttonRemove(){return this.getAttribute("button-remove")}get buttonMove(){return this.getAttribute("button-move")}get rowsContainer(){return this.getAttribute("rows-container")}get repeatableElement(){return this.getAttribute("repeatable-element")}get minimum(){return this.getAttribute("minimum")}get maximum(){return this.getAttribute("maximum")}get name(){return this.getAttribute("name")}set name(t){return this.template=this.template.replace(new RegExp(` name="${this.name.replace(/[[\]]/g,"\\$&")}`,"g"),` name="${t}`),this.setAttribute("name",t)}constructor(){super();const t=this;if(this.containerWithRows=this,this.rowsContainer){const t=this.querySelectorAll(this.rowsContainer);Array.from(t).forEach((t=>{t.closest("joomla-field-subform")===this&&(this.containerWithRows=t)}))}this.lastRowIndex=this.getRows().length-1,this.template="",this.prepareTemplate(),(this.buttonAdd||this.buttonRemove)&&(this.addEventListener("click",(e=>{let r=null,a=null;if(t.buttonAdd&&(r=e.target.matches(t.buttonAdd)?e.target:e.target.closest(t.buttonAdd)),t.buttonRemove&&(a=e.target.matches(t.buttonRemove)?e.target:e.target.closest(t.buttonRemove)),r&&r.closest("joomla-field-subform")===t){let a=r.closest("joomla-field-subform");a=a.closest(t.repeatableElement)===t?a:null,t.addRow(a),e.preventDefault()}else if(a&&a.closest("joomla-field-subform")===t){const r=a.closest(t.repeatableElement);t.removeRow(r),e.preventDefault()}})),this.addEventListener("keydown",(r=>{if(r.keyCode!==e)return;const a=t.buttonAdd&&r.target.matches(t.buttonAdd),s=t.buttonRemove&&r.target.matches(t.buttonRemove);if((a||s)&&r.target.closest("joomla-field-subform")===t){let e=r.target.closest("joomla-field-subform");e=e.closest(t.repeatableElement)===t?e:null,s&&e?t.removeRow(e):a&&t.addRow(e),r.preventDefault()}}))),this.buttonMove&&this.setUpDragSort()}getRows(){const t=Array.from(this.containerWithRows.children),e=[];return t.forEach((t=>{t.matches(this.repeatableElement)&&e.push(t)})),e}prepareTemplate(){const t=[].slice.call(this.children).filter((t=>t.classList.contains("subform-repeatable-template-section")));if(t[0]&&(this.template=t[0].innerHTML),!this.template)throw new Error("The row template are required to subform element to work")}addRow(t){const e=this.getRows().length;if(e>=this.maximum)return null;let r;r="TBODY"===this.containerWithRows.nodeName||"TABLE"===this.containerWithRows.nodeName?document.createElement("tbody"):document.createElement("div"),r.innerHTML=this.template;const a=r.children[0];return t?t.parentNode.insertBefore(a,t.nextSibling):this.containerWithRows.append(a),this.buttonMove&&(a.setAttribute("draggable","false"),a.setAttribute("aria-grabbed","false"),a.setAttribute("tabindex","0")),a.setAttribute("data-new","1"),this.fixUniqueAttributes(a,e),this.dispatchEvent(new CustomEvent("subform-row-add",{detail:{row:a},bubbles:!0})),window.Joomla&&Joomla.Event.dispatch(a,"joomla:updated"),a}removeRow(t){this.getRows().length<=this.minimum||(this.dispatchEvent(new CustomEvent("subform-row-remove",{detail:{row:t},bubbles:!0})),window.Joomla&&Joomla.Event.dispatch(t,"joomla:removed"),t.parentNode.removeChild(t))}fixUniqueAttributes(t,e){const r=e||0,a=t.getAttribute("data-group"),s=t.getAttribute("data-base-name"),o=Math.max(this.lastRowIndex,r),i=s+o;this.lastRowIndex=o+1,t.setAttribute("data-group",i);let l=t.querySelectorAll("[name]");const n={};l=[].slice.call(l).filter((t=>t.closest("joomla-field-subform")===this)),l.forEach((e=>{const r=e,s=r.getAttribute("name"),o=s.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),l=s.replace(`[${a}][`,`[${i}][`);let u=o.replace(a,i).replace(/\W/g,"_"),b=0,d=o;if("checkbox"===r.type&&s.match(/\[\]$/)){if(b=n[o]?n[o].length:0,!b){const e=r.closest("fieldset.checkboxes"),a=t.querySelector(`label[for="${o}"]`);e&&e.setAttribute("id",u),a&&(a.setAttribute("for",u),a.setAttribute("id",`${u}-lbl`))}d+=b,u+=b}else if("radio"===r.type){if(b=n[o]?n[o].length:0,!b){const e=r.closest("fieldset.radio"),a=t.querySelector(`label[for="${o}"]`);e&&e.setAttribute("id",u),a&&(a.setAttribute("for",u),a.setAttribute("id",`${u}-lbl`))}d+=b,u+=b}n[o]?n[o].push(!0):n[o]=[!0],r.name=l,r.id&&(r.id=u);const m=t.querySelector(`label[for="${d}"]`);m&&(m.setAttribute("for",u),m.setAttribute("id",`${u}-lbl`))}))}setUpDragSort(){const t=this;let s=null,o=!1;function i(e){return!e.form&&e.matches(t.buttonMove)?e:e.closest(t.buttonMove)}function l(t,e){let r=!1;if(t.parentNode===e.parentNode)for(let a=t;a;a=a.previousSibling)if(a===e){r=!0;break}r?e.parentNode.insertBefore(t,e):e.parentNode.insertBefore(t,e.nextSibling)}Array.from(this.getRows()).forEach((t=>{t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t.setAttribute("tabindex","0")})),this.addEventListener("touchstart",(e=>{o=!0;const r=i(e.target),a=r?r.closest(t.repeatableElement):null;a&&a.closest("joomla-field-subform")===t&&(s?(a!==s&&l(s,a),s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),s=null):(a.setAttribute("draggable","true"),a.setAttribute("aria-grabbed","true"),s=a),e.preventDefault())})),this.addEventListener("mousedown",(({target:e})=>{if(o)return;const r=i(e),a=r?r.closest(t.repeatableElement):null;a&&a.closest("joomla-field-subform")===t&&(a.setAttribute("draggable","true"),a.setAttribute("aria-grabbed","true"),s=a)})),this.addEventListener("mouseup",(()=>{s&&!o&&(s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),s=null)})),this.addEventListener("keydown",(o=>{if(o.keyCode!==r&&o.keyCode!==e&&o.keyCode!==a||o.target.form||!o.target.matches(t.repeatableElement))return;const i=o.target;if(i&&i.closest("joomla-field-subform")===t&&(o.keyCode===e&&function(t){return t.ctrlKey||t.metaKey||t.shiftKey}(o)&&("true"===i.getAttribute("aria-grabbed")?(i.setAttribute("draggable","false"),i.setAttribute("aria-grabbed","false"),s=null):(s&&(s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),s=null),i.setAttribute("draggable","true"),i.setAttribute("aria-grabbed","true"),s=i),o.preventDefault()),o.keyCode===r&&s&&(s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),s=null),o.keyCode===a&&s)){if(s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),i===s)return void(s=null);l(s,i),o.preventDefault(),s=null}})),this.addEventListener("dragstart",(({dataTransfer:t})=>{s&&(t.effectAllowed="move",t.setData("text",""))})),this.addEventListener("dragover",(t=>{s&&t.preventDefault()})),this.addEventListener("dragenter",(({target:e})=>{if(!s||t.rowsContainer&&e.closest(t.rowsContainer)!==t.containerWithRows)return;const r=e.matches(t.repeatableElement)?e:e.closest(t.repeatableElement);r&&l(s,r)})),this.addEventListener("dragend",(()=>{s&&(s.setAttribute("draggable","false"),s.setAttribute("aria-grabbed","false"),s=null)}))}}t.define("joomla-field-subform",s)})(customElements);