"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _createSuper(t){var e=_isNativeReflectConstruct();return function(){var r,n=_getPrototypeOf(t);if(e){var o=_getPrototypeOf(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return _possibleConstructorReturn(this,r)}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _wrapNativeSuper(t){var e="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(t){if(null===t||!_isNativeFunction(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return _construct(t,arguments,_getPrototypeOf(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(r,t)})(t)}function _construct(t,e,r){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var o=new(Function.bind.apply(t,n));return r&&_setPrototypeOf(o,r.prototype),o}).apply(null,arguments)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function _isNativeFunction(t){return-1!==Function.toString.call(t).indexOf("[native code]")}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}!function(t){var e=32,r=27,n=13;var o=function(t){_inherits(a,_wrapNativeSuper(HTMLElement));var o=_createSuper(a);function a(){var t;_classCallCheck(this,a);var r=_assertThisInitialized(t=o.call(this));if(t.containerWithRows=_assertThisInitialized(t),t.rowsContainer){var n=t.querySelectorAll(t.rowsContainer);Array.from(n).forEach((function(e){e.closest("joomla-field-subform")===_assertThisInitialized(t)&&(t.containerWithRows=e)}))}return t.lastRowIndex=t.getRows().length-1,t.template="",t.prepareTemplate(),(t.buttonAdd||t.buttonRemove)&&(t.addEventListener("click",(function(t){var e=null,n=null;if(r.buttonAdd&&(e=t.target.matches(r.buttonAdd)?t.target:t.target.closest(r.buttonAdd)),r.buttonRemove&&(n=t.target.matches(r.buttonRemove)?t.target:t.target.closest(r.buttonRemove)),e&&e.closest("joomla-field-subform")===r){var o=e.closest("joomla-field-subform");o=o.closest(r.repeatableElement)===r?o:null,r.addRow(o),t.preventDefault()}else if(n&&n.closest("joomla-field-subform")===r){var a=n.closest(r.repeatableElement);r.removeRow(a),t.preventDefault()}})),t.addEventListener("keydown",(function(t){if(t.keyCode===e){var n=r.buttonAdd&&t.target.matches(r.buttonAdd),o=r.buttonRemove&&t.target.matches(r.buttonRemove);if((n||o)&&t.target.closest("joomla-field-subform")===r){var a=t.target.closest("joomla-field-subform");a=a.closest(r.repeatableElement)===r?a:null,o&&a?r.removeRow(a):n&&r.addRow(a),t.preventDefault()}}}))),t.buttonMove&&t.setUpDragSort(),t}return _createClass(a,[{key:"buttonAdd",get:function(){return this.getAttribute("button-add")}},{key:"buttonRemove",get:function(){return this.getAttribute("button-remove")}},{key:"buttonMove",get:function(){return this.getAttribute("button-move")}},{key:"rowsContainer",get:function(){return this.getAttribute("rows-container")}},{key:"repeatableElement",get:function(){return this.getAttribute("repeatable-element")}},{key:"minimum",get:function(){return this.getAttribute("minimum")}},{key:"maximum",get:function(){return this.getAttribute("maximum")}},{key:"name",get:function(){return this.getAttribute("name")},set:function(t){return this.template=this.template.replace(new RegExp(' name="'.concat(this.name.replace(/[[\]]/g,"\\$&")),"g"),' name="'.concat(t)),this.setAttribute("name",t)}},{key:"getRows",value:function(){var t=this,e=Array.from(this.containerWithRows.children),r=[];return e.forEach((function(e){e.matches(t.repeatableElement)&&r.push(e)})),r}},{key:"prepareTemplate",value:function(){var t=[].slice.call(this.children).filter((function(t){return t.classList.contains("subform-repeatable-template-section")}));if(t[0]&&(this.template=t[0].innerHTML),!this.template)throw new Error("The row template are required to subform element to work")}},{key:"addRow",value:function(t){var e,r=this.getRows().length;if(r>=this.maximum)return null;(e="TBODY"===this.containerWithRows.nodeName||"TABLE"===this.containerWithRows.nodeName?document.createElement("tbody"):document.createElement("div")).innerHTML=this.template;var n=e.children[0];return t?t.parentNode.insertBefore(n,t.nextSibling):this.containerWithRows.append(n),this.buttonMove&&(n.setAttribute("draggable","false"),n.setAttribute("aria-grabbed","false"),n.setAttribute("tabindex","0")),n.setAttribute("data-new","1"),this.fixUniqueAttributes(n,r),this.dispatchEvent(new CustomEvent("subform-row-add",{detail:{row:n},bubbles:!0})),window.Joomla&&Joomla.Event.dispatch(n,"joomla:updated"),n}},{key:"removeRow",value:function(t){this.getRows().length<=this.minimum||(this.dispatchEvent(new CustomEvent("subform-row-remove",{detail:{row:t},bubbles:!0})),window.Joomla&&Joomla.Event.dispatch(t,"joomla:removed"),t.parentNode.removeChild(t))}},{key:"fixUniqueAttributes",value:function(t,e){var r=this,n=e||0,o=t.getAttribute("data-group"),a=t.getAttribute("data-base-name"),i=Math.max(this.lastRowIndex,n),s=a+i;this.lastRowIndex=i+1,t.setAttribute("data-group",s);var u=t.querySelectorAll("[name]"),l={};(u=[].slice.call(u).filter((function(t){return t.closest("joomla-field-subform")===r}))).forEach((function(e){var r=e,n=r.getAttribute("name"),a=n.replace(/(\[\]$)/g,"").replace(/(\]\[)/g,"__").replace(/\[/g,"_").replace(/\]/g,""),i=n.replace("[".concat(o,"]["),"[".concat(s,"][")),u=a.replace(o,s).replace(/\W/g,"_"),c=0,f=a;if("checkbox"===r.type&&n.match(/\[\]$/)){if(!(c=l[a]?l[a].length:0)){var b=r.closest("fieldset.checkboxes"),d=t.querySelector('label[for="'.concat(a,'"]'));b&&b.setAttribute("id",u),d&&(d.setAttribute("for",u),d.setAttribute("id","".concat(u,"-lbl")))}f+=c,u+=c}else if("radio"===r.type){if(!(c=l[a]?l[a].length:0)){var p=r.closest("fieldset.radio"),m=t.querySelector('label[for="'.concat(a,'"]'));p&&p.setAttribute("id",u),m&&(m.setAttribute("for",u),m.setAttribute("id","".concat(u,"-lbl")))}f+=c,u+=c}l[a]?l[a].push(!0):l[a]=[!0],r.name=i,r.id&&(r.id=u);var g=t.querySelector('label[for="'.concat(f,'"]'));g&&(g.setAttribute("for",u),g.setAttribute("id","".concat(u,"-lbl")))}))}},{key:"setUpDragSort",value:function(){var t=this,o=null,a=!1;function i(e){return!e.form&&e.matches(t.buttonMove)?e:e.closest(t.buttonMove)}function s(t,e){var r=!1;if(t.parentNode===e.parentNode)for(var n=t;n;n=n.previousSibling)if(n===e){r=!0;break}r?e.parentNode.insertBefore(t,e):e.parentNode.insertBefore(t,e.nextSibling)}Array.from(this.getRows()).forEach((function(t){t.setAttribute("draggable","false"),t.setAttribute("aria-grabbed","false"),t.setAttribute("tabindex","0")})),this.addEventListener("touchstart",(function(e){a=!0;var r=i(e.target),n=r?r.closest(t.repeatableElement):null;n&&n.closest("joomla-field-subform")===t&&(o?(n!==o&&s(o,n),o.setAttribute("draggable","false"),o.setAttribute("aria-grabbed","false"),o=null):(n.setAttribute("draggable","true"),n.setAttribute("aria-grabbed","true"),o=n),e.preventDefault())})),this.addEventListener("mousedown",(function(e){var r=e.target;if(!a){var n=i(r),s=n?n.closest(t.repeatableElement):null;s&&s.closest("joomla-field-subform")===t&&(s.setAttribute("draggable","true"),s.setAttribute("aria-grabbed","true"),o=s)}})),this.addEventListener("mouseup",(function(){o&&!a&&(o.setAttribute("draggable","false"),o.setAttribute("aria-grabbed","false"),o=null)})),this.addEventListener("keydown",(function(a){if(!(a.keyCode!==r&&a.keyCode!==e&&a.keyCode!==n||a.target.form)&&a.target.matches(t.repeatableElement)){var i=a.target;if(i&&i.closest("joomla-field-subform")===t&&(a.keyCode===e&&function(t){return t.ctrlKey||t.metaKey||t.shiftKey}(a)&&("true"===i.getAttribute("aria-grabbed")?(i.setAttribute("draggable","false"),i.setAttribute("aria-grabbed","false"),o=null):(o&&(o.setAttribute("draggable","false"),o.setAttribute("aria-grabbed","false"),o=null),i.setAttribute("draggable","true"),i.setAttribute("aria-grabbed","true"),o=i),a.preventDefault()),a.keyCode===r&&o&&(o.setAttribute("draggable","false"),o.setAttribute("aria-grabbed","false"),o=null),a.keyCode===n&&o)){if(o.setAttribute("draggable","false"),o.setAttribute("aria-grabbed","false"),i===o)return void(o=null);s(o,i),a.preventDefault(),o=null}}})),this.addEventListener("dragstart",(function(t){var e=t.dataTransfer;o&&(e.effectAllowed="move",e.setData("text",""))})),this.addEventListener("dragover",(function(t){o&&t.preventDefault()})),this.addEventListener("dragenter",(function(e){var r=e.target;if(o&&(!t.rowsContainer||r.closest(t.rowsContainer)===t.containerWithRows)){var n=r.matches(t.repeatableElement)?r:r.closest(t.repeatableElement);n&&s(o,n)}})),this.addEventListener("dragend",(function(){o&&(o.setAttribute("draggable","false"),o.setAttribute("aria-grabbed","false"),o=null)}))}}]),a}();t.define("joomla-field-subform",o)}(customElements);